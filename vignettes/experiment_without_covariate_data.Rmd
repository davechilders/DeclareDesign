---
title: "How to Design and Pre-Register Experimental Designs with Baseline Data"
author: "Experiments in Governance and Politics (EGAP)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to Pre-Register a Simple Experimental Design using the registration package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
This vignette demonstrates how to design and pre-register an experiment after baseline data has been collected.

```{r, echo = FALSE}
library(experimentr)
library(knitr)

set.seed(20)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = TRUE, message = FALSE, 
                      eval = TRUE, tidy = TRUE, tidy.opts = list(width.cutoff = 50),
                      strip_white = TRUE, results = 'asis', fix.ext = 'pdf')
```

# A simple experiment

## Designing the experiment

First, we define the sample frame from which we will draw a sample to run the experiment from. This includes defining the levels of analysis and the covariates at each level.

```{r}
sample <- declare_sample(
  income = declare_variable(),
  N = 500)
```

Second, we define the potential outcomes, which will be simulated based on the baseline covariate data.

```{r}
potential_outcomes     <-  declare_potential_outcomes(
  condition_names = c("Z0","Z1"),
  outcome_formula = Y ~ .01 + 0*Z0 + .2*Z1 + .1*income 
)
```

Fourth, we define one or more analyses we will run based on simulated data. This analysis will also be used for power analysis.


```{r}
analysis      <- declare_analysis(formula = Y ~ Z, treatment_variable = "Z", estimator = difference_in_means)
```

Then we declare the design of the experiment, in this case a simple one without clusters or blocking.

```{r}
design <- declare_design(potential_outcomes = potential_outcomes)
```

Before finalizing the design, we conduct a power analysis to determine whether 500 units and 10 clusters (villages) are sufficient. To do this, we use the diagnose function.

```{r}
simulations <- diagnose(potential_outcomes = potential_outcomes, 
                                   sample = sample, 
                                   design = design, 
                                   analysis = analysis)
kable(summary(simulations), digits = 3)
```

This indicates the power, `summary(simulations)[3]`, is less than the typical threshold of `0.8`. To address this problem, we can conduct a power analysis varying the number of units in the study to find an appropriate sample size. This can be accomplished with compare_experiments.

```{r}
comparisons <- compare_experiments(N = c(100, 500, 750, 1000, 1250, 1500),
                                   potential_outcomes = potential_outcomes, 
                                   sample = sample, 
                                   design = design, 
                                   analysis = analysis, 
                                   sims = 100)
kable(summary(comparisons), digits = 3)
```

## Mock analysis

After settling on a sample size and a final design, we can conduct a mock analysis of the data to ensure we are satisfied with the analysis of the data. To do this, we create mock data -- simulated from the distributions we set -- and then run the analyses on the simulated data.

```{r}
mock <- make_data(sample = sample, potential_outcomes = potential_outcomes,
                  design = design,
                  assign_treatment = TRUE, observed_outcomes = TRUE,
                  treatment_variable = "Z")
```

```{r}
kable(get_estimates(analysis = analysis, data = mock), digits = 3)
```

```{r}
kable(get_estimands(analysis = analysis, data = mock), digits = 3)
```

## Pre-registering the experiment

Finally, we use the pre_register function to create the pre-registration document.

```{r, eval = FALSE}
pre <- pre_register(design = design, sample = sample, 
                    potential_outcomes = potential_outcomes, analysis = analysis, 
                    title = "Lady Tasting Tea", 
                    author = c("Ronald A. Fisher"), 
                    abstract = "Description of the lady tasting tea experiment")
```

```{r, eval = FALSE, echo = FALSE}
pre <- pre_register(design = design, sample = sample, 
                    potential_outcomes = potential_outcomes, analysis = analysis, 
                    title = "Lady Tasting Tea", 
                    author = c("Ronald A. Fisher"), 
                    abstract = "Description of the lady tasting tea experiment",
                    temp_dir = TRUE, make_output = FALSE)
```

## Writing a paper based on the experiment

```{r}
##draft_paper_from_pre_registration(pre, data = mock, temp_dir = TRUE)
```

# A cluster-randomized experiment with pair blocking

Instead of pre-registering and using this simple design, we may want to consider a more complex one that accounts for clustering in the outcomes, for example within neighborhoods or villages. We may also want to block on certain cluster-level characteristics, such as demographic characteristics, before randomizing clusters into treatment conditions.

## Designing the experiment

The set up of the sample frame, potential outcomes, and analysis is similar. In this case, we add to the potential outcomes an intra-cluster correlation of .2 using the variable villages_id as the cluster variable.

```{r}
sample_block_cluster <- declare_sample(
  individuals = list(
    income = declare_variable()),
  villages = list(
    development_level = declare_variable(multinomial_probabilities = 1:3/sum(1:3))
  ),
  N_per_level = c(500, 100))

potential_outcomes_block_cluster     <-  declare_potential_outcomes(
  condition_names = c("Z0","Z1"),
  outcome_formula = Y ~ .01 + 0*Z0 + .15*Z1 + .1*income + .15*Z1*income
)

analysis_block_cluster <- declare_analysis(formula = Y ~ Z, treatment_variable = "Z", 
                                           estimator = difference_in_means)
```

To initiate the clustering in the design, we use the declare_cluster function,

```{r}
clusters <- declare_clusters(clusters = "villages_id")
```

To define a simple blocking scheme, where units are blocked according to the value of the covariate development_level, we use the declare_blocks function. 

```{r}
blocks <- declare_blocks(blocks = "development_level", recode = FALSE, clusters = clusters)
```

Fourth, we define one or more analyses we will run based on simulated data. This analysis will also be used for power analysis.


Then we declare the design of the experiment, adding in the information about clusters and blocks declared above.

```{r}
design_block_cluster <- declare_design(potential_outcomes = potential_outcomes_block_cluster, 
                                       clusters = clusters, blocks = blocks)
```

Before finalizing the design, we conduct a power analysis to determine whether 500 units and 10 clusters (villages) are sufficient. To do this, we use the diagnose function.

```{r}
simulations_block_cluster <- diagnose(potential_outcomes = potential_outcomes_block_cluster, 
                                   sample = sample_block_cluster, 
                                   design = design_block_cluster, 
                                   analysis = analysis_block_cluster)
kable(summary(simulations_block_cluster), digits = 3)
```

This indicates the power, `summary(simulations)[3]`, is less than the typical threshold of `0.8`. To address this problem, we can conduct a power analysis varying the number of units in the study to find an appropriate sample size. This can be accomplished with compare_experiments.

```{r}
comparisons_block_cluster  <- compare_experiments(N_per_level = list(c(1000, 50), c(500, 50), c(200, 100)),
                                   potential_outcomes = potential_outcomes_block_cluster, 
                                   sample =  sample_block_cluster, 
                                   design = design_block_cluster, 
                                   analysis = analysis_block_cluster, 
                                   sims = 100)
kable(summary(comparisons_block_cluster), digits = 3)
```

## Comparing the simple and complex designs

Before deciding on the complex design, we can compare the two designs in terms of power. We can use the compare_experiments function to do this, providing the appropriate objects representing each different design.

```{r}
comparisons_block_cluster  <- compare_experiments(
  potential_outcomes = list(potential_outcomes, potential_outcomes_block_cluster), 
  sample = list(sample, sample_block_cluster), 
  design = list(design, design_block_cluster), 
  clusters = list(NULL, clusters),
  blocks = list(NULL, blocks),
  analysis = list(analysis, analysis_block_cluster), 
  sims = 100)

kable(summary(comparisons_block_cluster), digits = 3)
```

## Mock analysis

After settling on a sample size and a final design, we can conduct a mock analysis of the data to ensure we are satisfied with the analysis of the data. To do this, we create mock data -- simulated from the distributions we set -- and then run the analyses on the simulated data.

```{r}
mock <- make_data(sample = sample_block_cluster, potential_outcomes = potential_outcomes_block_cluster,
                  design = design_block_cluster, assign_treatment = TRUE, observed_outcomes = TRUE,
                  treatment_variable = "Z")
```

```{r}
kable(get_estimates(analysis = analysis, data = mock), digits = 3)
```

## Pre-registering the experiment

Finally, we use the pre_register function again to create the pre-registration document based on the blocked and clustered design.

```{r, eval = FALSE}
pre <- pre_register(design = design_block_cluster, sample = sample_block_cluster, 
                    potential_outcomes = potential_outcomes_block_cluster, analysis = analysis_block_cluster, 
                    title = "Lady Tasting Tea", 
                    author = c("Ronald A. Fisher"), 
                    abstract = "Description of the lady tasting tea experiment")
```

```{r, echo = FALSE, eval = FALSE}
pre <- pre_register(design = design_block_cluster, sample = sample_block_cluster, 
                    potential_outcomes = potential_outcomes_block_cluster, analysis = analysis_block_cluster, 
                    title = "Lady Tasting Tea", 
                    author = c("Ronald A. Fisher"), 
                    abstract = "Description of the lady tasting tea experiment",
                    temp_dir = TRUE, make_output = FALSE)
```

## Writing a paper based on the experiment

```{r, echo = TRUE, eval = FALSE}
##draft_paper_from_pre_registration(pre, data = mock)
```

