---
title: "How to Design and Pre-Register Experimental Designs with Baseline Data"
author: "Experiments in Governance and Politics (EGAP)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to Pre-Register a Simple Experimental Design using the registration package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
  This vignette demonstrates how to design and pre-register an experiment after baseline data has been collected.

```{r, echo = FALSE}
library(registration)
library(xtable)
set.seed(5)
knitr::opts_knit$set(root.dir = tempdir())
```

First, we define the sample frame from which we will draw a sample to run the experiment from. This includes defining the levels of analysis and the covariates at each level.

```{r, echo = FALSE}
sample_frame <- declare_sample_frame(
  individuals = list(
    income = declare_variable()),
  villages = list(
    development_level = declare_variable(multinomial_probabilities = 1:5/sum(1:5))
  ),
  lower_units_per_level = list(
    individuals = rep(1,1000), 
    villages = rep(5,200)
  ))
```

Second, we define the potential outcomes, which will be simulated based on the baseline covariate data.

```{r}
potential_outcomes     <-  declare_potential_outcomes(
  condition_names = c("Z0","Z1"),
  outcome_formula = Y ~ .01 + 0*Z0 + .2*Z1 + .1*income,
  cluster_variable = "villages_id",
  ICC = .2
)
```

Fourth, we define one or more analyses we will run based on simulated data. This analysis will also be used for power analysis.


```{r}
analysis      <- declare_analysis(formula = Y ~ Z + income + development_level, treatment_variable = "Z",
                                  method = "lm")
```

Then we declare the design of the experiment, in this case a simple one without clusters or blocking.

```{r}
design <- declare_design(potential_outcomes = potential_outcomes)
```

Before finalizing the design, we conduct a power analysis to determine whether 500 units and 10 clusters (villages) are sufficient. To do this, we use the simulate_experiment function.

```{r}
simulations <- simulate_experiment(potential_outcomes = potential_outcomes, 
                                   sample_frame =  sample_frame, 
                                   design = design, 
                                   analysis = analysis)
print(xtable(summary(simulations)))
```

This indicates the power, `summary(simulations)[3]`, is less than the typical threshold of `0.8`. To address this problem, we can conduct a power analysis varying the number of units in the study to find an appropriate sample size. This can be accomplished with compare_experiments.

```{r}
comparisons <- compare_experiments(N_per_level = list(c(1000, 20), c(500, 50), c(250, 100)),
                                   potential_outcomes = potential_outcomes, 
                                   sample_frame =  sample_frame, 
                                   design = design, 
                                   analysis = analysis, 
                                   sims = 100)
print(xtable(summary(comparisons)))
```

After settling on a sample size and a final design, we can conduct a mock analysis of the data to ensure we are satisfied with the analysis of the data. To do this, we create mock data -- simulated from the distributions we set -- and then run the analyses on the simulated data.

```{r}
mock <- make_data(sample_frame = sample_frame, potential_outcomes = potential_outcomes)
mock$Z <- assign_treatment(design = design, data = mock)
mock$Y <- observed_outcome(outcome = "Y", treatment_assignment = "Z", data = mock)
```

```{r}
get_estimates(analysis = analysis, data = mock)
```

Finally, we use the pre_register function to create the pre-registration document.

```{r}
pre <- pre_register(design = design, sample_frame = sample_frame, 
                    potential_outcomes = potential_outcomes, analysis = analysis, 
                    title = "Lady Tasting Tea", 
                    author = c("Ronald A. Fisher"), 
                    abstract = "Description of the lady tasting tea experiment",
                    temp_dir = TRUE, open_output = FALSE)
```
